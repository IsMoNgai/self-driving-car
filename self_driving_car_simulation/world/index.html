<!DOCTYPE html>
<html>
    <head>
        <title>World Editor</title>
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <!-- <h1>World Editor</h1> -->
        <h1></h1>
        <div style="display: flex; flex-direction: row;">
            <div style="padding-left: 10%">
                <canvas id="myCanvas"></canvas>
                <div id="controls">
                    <button onclick="dispose()">Remove All</button>
                    <button onclick="save()">Save</button>
                    <label for="fileInput" class="file-input-label">
                        üìÅ
                        <input 
                            type="file"
                            id="fileInput"
                            accept=".world"
                            onchange="load(event)"
                        />
                    </label>
                    <button onclick="openOsmPanel()">üó∫Ô∏è</button>
                    &nbsp;
                    <button id="graphBtn" onclick="setMode('graph')">üåê</button>
                    <button id="stopBtn" onclick="setMode('stop')">üõë</button>
                    <button id="crossingBtn" onclick="setMode('crossing')">üßç</button>
                    <button id="startBtn" onclick="setMode('start')">üöó</button>
                    <button id="showTreeBtn" onclick="toggleShowTree()">üå≥</button>
                    <button id="showBuildingBtn" onclick="toggleShowBuilding()">üè¢</button>
                
                    <div id="osmPanel" style="display:none">
                        <a href="https://overpass-turbo.eu/#">click here</a>
                        <textarea id="osmDataContainer" rows="10" cols="50" placeholder="Paste OSM data here"></textarea>
                        <div>
                            <button onclick="parseOsmData()">open</button>
                            <button onclick="closeOsmPanel()">close</button>
                        </div>
                    </div>
                </div>            
            </div>
            <div style="width: 100%; display: flex; justify-content: left; flex-direction: column; padding-left: 2%;">
                <h4 style="text-align: left; margin-bottom: 0%;">Generate Tree</h4>
                <label class="switch">
                    <input type="checkbox" id="genTree">
                    <span class="slider round"></span>
                </label>
                <h4 style="text-align: left; margin-bottom: 0%;">Generate Building</h4>
                <label class="switch">
                    <input type="checkbox" id="genBuilding">
                    <span class="slider round"></span>
                </label>
                <a style="text-align: left; color: white; padding-top: 5%;" href="../index.html">Run Simulation</a>
            </div>
        </div>

    
        <script src="js/world.js"></script>
        <script src="js/viewport.js"></script>
        <script src="js/markings/Marking.js"></script>
        <script src="js/markings/stop.js"></script>
        <script src="js/markings/crossing.js"></script>
        <script src="js/markings/start.js"></script>
        <script src="js/editors/markingEditor.js"></script>
        <script src="js/editors/graphEditor.js"></script>
        <script src="js/editors/stopEditor.js"></script>
        <script src="js/editors/crossingEditor.js"></script>
        <script src="js/editors/startEditor.js"></script>
        <script src="js/items/tree.js"></script>
        <script src="js/items/building.js"></script>
        <script src="js/math/utils.js"></script>
        <script src="js/math/graph.js"></script>
        <script src="js/math/osm.js"></script>
        <script src="js/primitives/point.js"></script>
        <script src="js/primitives/segment.js"></script>
        <script src="js/primitives/polygon.js"></script>
        <script src="js/primitives/envelope.js"></script>
        <script>
            myCanvas.width = 600;
            myCanvas.height = 600;

            let showTree = true;
            let showBuilding = true;

            const ctx = myCanvas.getContext("2d");

            const worldString = localStorage.getItem("world");
            const worldInfo = worldString ? JSON.parse(worldString) : null;
            let world = worldInfo 
                ? World.load(worldInfo) 
                : new World(new Graph());

            const graph = world.graph;

            const viewport = new Viewport(myCanvas, world.zoom, world.offset);

            const tools = {
                graph: { button: graphBtn, editor: new GraphEditor(viewport, graph)},
                stop: { button: stopBtn, editor: new StopEditor(viewport, world)},
                crossing: { button: crossingBtn, editor: new CrossingEditor(viewport, world)},
                start: { button: startBtn, editor: new StartEditor(viewport, world)}
            };

            // create a unique identifier so we only generate random trees once
            let oldGraphHash = graph.hash();

            setMode("graph");

            animate();
  
            function animate() {
                viewport.reset();
                const genTree = document.getElementById("genTree").checked;
                const genBuilding = document.getElementById("genBuilding").checked;
                // create a unique identifier so we only generate random trees once
                if (graph.hash() != oldGraphHash) {
                    // for future optimization one can generate graph first then generate world
                    // so it will boost the generation speed for just graph design 
                    // and when you are ready then generate the whole world
                    world.generate(genTree, genBuilding);              
                    oldGraphHash = graph.hash();      
                }
                
                const viewPoint = scale(viewport.getOffset(), -1);
                world.draw(ctx, viewPoint, true, 1000, showBuilding, showTree);
                ctx.globalAlpha = 0.3;
                for (const tool of Object.values(tools)) {
                    tool.editor.display();
                }
                // new Polygon(graph.points).draw(ctx);
                // new Envelope(graph.segments[0], 200, 20).draw(ctx);
                requestAnimationFrame(animate); 
            }

            function dispose() {
                tools['graph'].editor.dispose();
                world.markings.length = 0;
            }

            function save() {
                world.zoom = viewport.zoom;
                world.offset = viewport.offset;

                const element = document.createElement("a");
                element.setAttribute(
                    "href",
                    "data:application/json;charset=utf-8," +
                        encodeURIComponent(JSON.stringify(world))
                );

                const fileName = "name.world";
                element.setAttribute("download", fileName);

                element.click();

                localStorage.setItem("world", JSON.stringify(world));
            }

            function toggleShowBuilding() {
                showBuilding = !showBuilding;
                if(!showBuilding) {
                    showBuildingBtn.style.backgroundColor = "gray";
                    showBuildingBtn.style.filter= "grayscale(100%)";
                } else {
                    showBuildingBtn.style.backgroundColor = "white";
                    showBuildingBtn.style.filter= "";
                }

            }

            function toggleShowTree() {
                showTree = !showTree;
                if(!showTree) {
                    showTreeBtn.style.backgroundColor = "gray";
                    showTreeBtn.style.filter= "grayscale(100%)";
                } else {
                    showTreeBtn.style.backgroundColor = "white";
                    showTreeBtn.style.filter= "";
                }
            }

            document.getElementById("genTree").addEventListener("change", () => {
                const genTree = document.getElementById("genTree").checked;
                const genBuilding = document.getElementById("genBuilding").checked;
                world.generate(genTree, genBuilding);
            });

            document.getElementById("genBuilding").addEventListener("change", () => {
                const genTree = document.getElementById("genTree").checked;
                const genBuilding = document.getElementById("genBuilding").checked;
                world.generate(genTree, genBuilding);
            });

            function load(event) {
                const file = event.target.files[0];

                if(!file) {
                    alert("No file selected.");
                    return;
                }

                const reader = new FileReader();
                reader.readAsText(file);

                reader.onload = (evt) => {
                    const fileContent = evt.target.result;
                    const jsonData = JSON.parse(fileContent);
                    world = World.load(jsonData);
                    localStorage.setItem("world", JSON.stringify(world));
                    location.reload();
                }
            }

            function setMode(mode) {
                disableEditors();
                tools[mode].button.style.backgroundColor = "white";
                tools[mode].button.style.filter= "";
                tools[mode].editor.enable();
            }

            function disableEditors() {
                for (const tool of Object.values(tools)) {
                    tool.button.style.backgroundColor = "gray";
                    tool.button.style.filter= "grayscale(100%)";
                    tool.editor.disable();
                }
            }

            function openOsmPanel() {
                osmPanel.style.display = "block";
            }

            function closeOsmPanel() {
                osmPanel.style.display = "none";
            }

            function parseOsmData() {
                if (osmDataContainer.value == "") {
                    alert("Paste data first");
                    return;
                }
                const res = Osm.parseRoads(JSON.parse(osmDataContainer.value));
                graph.points = res.points;
                graph.segments = res.segments;
                closeOsmPanel();
            }
         </script>
    </body>
</html>